---
import { useState } from 'react';
import { motion } from 'framer-motion';
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';
import { getCollection } from 'astro:content';
import FormattedDate from '../../components/FormattedDate.astro';
import { Image } from 'astro:assets';

const posts = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// React Component: Theme Toggle
const ThemeToggle = () => {
  const [theme, setTheme] = useState('light');
  
  const toggleTheme = () => {
    const newTheme = theme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
    document.documentElement.setAttribute('data-theme', newTheme);
  };

  return (
    <motion.button
      onClick={toggleTheme}
      className="fixed top-4 right-4 p-2 rounded-full bg-accent text-white"
      whileHover={{ scale: 1.1 }}
      whileTap={{ scale: 0.95 }}
      aria-label={`Switch to ${theme === 'light' ? 'dark' : 'light'} mode`}
    >
      {theme === 'light' ? 'üåô' : '‚òÄÔ∏è'}
    </motion.button>
  );
};

// React Component: Blog Post Card
const BlogPostCard = ({ post }) => (
  <motion.li
    initial={{ opacity: 0, y: 20 }}
    animate={{ opacity: 1, y: 0 }}
    transition={{ duration: 0.5 }}
    whileHover={{ scale: 1.02 }}
    className="post-card"
  >
    <a href={`/blog/${post.id}/`} className="block">
      {post.data.heroImage && (
        <Image
          width={720}
          height={360}
          src={post.data.heroImage}
          alt={post.data.title}
          className="mb-2 rounded-lg shadow-box"
        />
      )}
      <h4 className="title text-heading text-xl font-bold">{post.data.title}</h4>
      <p className="date text-gray-dark">
        <FormattedDate date={post.data.pubDate} />
      </p>
    </a>
  </motion.li>
);

// Set initial theme based on system preference
const initialTheme = typeof window !== 'undefined' && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
if (typeof document !== 'undefined') {
  document.documentElement.setAttribute('data-theme', initialTheme);
}
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
    <style>
      @import url('/styles.css');
    </style>
  </head>
  <body>
    <Header />
    <main class="max-w-4xl mx-auto px-4 py-8">
      <ThemeToggle client:load />
      <section>
        <ul class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          {posts.map((post, index) => (
            <BlogPostCard post={post} key={post.id} client:load />
          ))}
        </ul>
      </section>
    </main>
    <Footer />
  </body>
</html>